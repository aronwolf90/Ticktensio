FROM node:10.6.0-alpine

FROM ruby:2.5.1-alpine3.7

WORKDIR  /app

ENV BUNDLE_BIN /app/bin
ENV YARN_VERSION 1.7.0

RUN apk --no-cache add rsync
RUN mkdir /tmp/local
COPY --from=0 /usr/local /tmp/local
RUN rsync -a /tmp/local/ /usr/local

COPY alphine_minimum_shared_install.sh ./
COPY alphine_shared_install.sh ./
RUN /app/alphine_shared_install.sh

COPY Gemfile Gemfile.lock ./
RUN bundle install

COPY yarn.lock package.json ./
RUN yarn install

COPY . /app
RUN [ -e config/database.yml ] && rm config/database.yml || true

RUN RAILS_ENV=production SECRET_KEY_BASE='9479a648d2fb' \
  DATABASE_URL=postgres://root:password@db%5Ftest/root \
  rake assets:precompile

RUN mkdir /assets && cp -r /app/public/assets /assets

# speed up tests on gitlab-ci
RUN mkdir -p /root/node_modules
RUN cp -R node_modules /root/


FROM node:10.6.0-alpine

FROM ruby:2.5.1-alpine3.7

ARG UID=1000
ARG GID=1000
ARG UNAME=user

WORKDIR  /app

ENV PATH /app/bin:/root/.yarn/bin:$PATH
ENV BUNDLE_BIN /app/bin
ENV HISTFILE=/app/tmp/bash_history
ENV YARN_VERSION 1.7.0

RUN apk update
RUN apk add rsync less shadow
RUN mkdir /tmp/local
COPY --from=0 /usr/local /tmp/local
RUN rsync -a /tmp/local/ /usr/local

COPY alphine_minimum_shared_install.sh ./
COPY alphine_shared_install.sh ./
RUN /app/alphine_shared_install.sh
RUN gem install foreman

RUN echo 'export PATH="/app/bin:$PATH"' >> /etc/profile

RUN apk add vim tmux

RUN chown -R $UID /usr/local/bundle
RUN chown -R $UID /usr/local/bundle

RUN deluser node

RUN groupadd -g $GID $UNAME
RUN useradd -m -u $UID -g $GID -s /bin/bash $UNAME -d /user
USER $UID:$GID

RUN git clone https://github.com/VundleVim/Vundle.vim.git /user/.vim/bundle/Vundle.vim
COPY .tmux.conf /user/.tmux.conf
COPY .vimrc /user/.vimrc
RUN vim +PluginInstall +qall
